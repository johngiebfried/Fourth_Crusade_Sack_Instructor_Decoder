<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sack Results Decoder - Instructor Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        // Same data as sack module
        const CHARACTERS = [
          { id: 1, name: 'Boniface of Montferrat' },
          { id: 2, name: 'Enrico Dandolo' },
          { id: 3, name: 'Baldwin of Flanders' },
          { id: 4, name: 'Bishop Nivelons of Soissons' },
          { id: 5, name: 'Robert of Clari' },
          { id: 6, name: 'Louis of Blois' },
          { id: 7, name: 'Angelo Falier' },
          { id: 8, name: 'John Faicete of Acre' },
          { id: 9, name: 'Hugh of Saint-Pol' },
          { id: 10, name: 'Anna/Agnes of France' },
          { id: 11, name: 'Oberto II of Biandrate' },
          { id: 12, name: 'Martin of Parisis' },
          { id: 13, name: 'Pantaleone Barbo' },
          { id: 14, name: 'Theodore Branas' },
          { id: 15, name: 'Geoffrey of Villehardouin' },
          { id: 16, name: 'Berthold of Katzenellenbogen' },
          { id: 17, name: 'Conrad of Halberstadt' },
          { id: 18, name: 'Marino Zeno' },
          { id: 19, name: 'Brother Barozzi' },
          { id: 20, name: 'Henry of Flanders' },
          { id: 21, name: 'Peter of Luciendo' },
          { id: 22, name: 'Pietro Steno' },
          { id: 23, name: 'Renier of Travele' },
          { id: 24, name: 'Conon of Bethune' },
          { id: 25, name: 'Raimbaut of Vaquiras' },
          { id: 26, name: 'Garnier of Troyes' },
          { id: 27, name: 'Marco Sanudo' },
          { id: 28, name: 'Othon of La Roche' },
          { id: 29, name: 'Peter of Amiens' },
          { id: 30, name: 'William of Arles' },
          { id: 31, name: 'Andrew Valero' },
          { id: 32, name: 'Amedee Pofey' },
          { id: 33, name: 'James of Avesnes' },
          { id: 34, name: 'Marino Ballaresso' },
          { id: 35, name: 'Peter of Bethlehem' },
          { id: 36, name: 'Piere Vidal' },
          { id: 37, name: 'Milo of Brebant' },
          { id: 38, name: 'Raveno della Carceri' },
          { id: 39, name: 'Andrea Balduino' },
          { id: 40, name: 'Peter of Bracieux' },
          { id: 41, name: 'Hugh of Saint-Ghislain' },
          { id: 42, name: 'Andre of Ureboise' },
          { id: 43, name: 'Guy of Pallavicini' },
          { id: 44, name: 'Matteo Steno' },
          { id: 45, name: 'Baldwin of Beauvoir' },
          { id: 46, name: 'Walon of Dampierre' },
          { id: 47, name: 'King Lalibela of Ethiopia' },
          { id: 48, name: 'Walframe of Gemona' },
          { id: 49, name: 'Eustace of Flanders' },
          { id: 50, name: 'Warin of Douai' },
          { id: 51, name: 'Henry of Ulmen' },
          { id: 52, name: 'Domenico of Constantinople' }
        ];

        const SCENARIOS = {
          "P1": {
            region: "Petrion",
            position: 1,
            questions: [
              {
                choices: [
                  { letter: "A", text: "Break wine-shop door, kill owner, take wine", marks: 10, fama: -2, nefas: 2 },
                  { letter: "B", text: "Distribute food to Greeks", marks: 0, fama: 3, nefas: -1 },
                  { letter: "C", text: "Take spices to resell", marks: 15, fama: 0, nefas: 0 },
                  { letter: "D", text: "Enslave northern importers", marks: 20, fama: -1, nefas: 3 }
                ]
              },
              {
                choices: [
                  { letter: "A", text: "Operate shops for profit", marks: 12, fama: 1, nefas: 0 },
                  { letter: "B", text: "Take icons from shops", marks: 8, fama: 2, nefas: 1 },
                  { letter: "C", text: "Start bonfire", marks: 0, fama: -3, nefas: 2 },
                  { letter: "D", text: "Search for strongboxes", marks: 18, fama: 0, nefas: 1 }
                ]
              },
              {
                choices: [
                  { letter: "A", text: "Take abbot's icon", marks: 5, fama: 2, nefas: 1 },
                  { letter: "B", text: "Take tiger pelt rug", marks: 15, fama: 0, nefas: 0 },
                  { letter: "C", text: "Take abbot's staff", marks: 8, fama: 1, nefas: 0 },
                  { letter: "D", text: "Take personal crucifix", marks: 10, fama: 3, nefas: 2 }
                ]
              }
            ]
          },
          "P2": {
            region: "Petrion",
            position: 2,
            questions: [
              {
                choices: [
                  { letter: "A", text: "Break wine-shop door, kill owner, take wine", marks: 10, fama: -2, nefas: 2 },
                  { letter: "B", text: "Distribute food to Greeks", marks: 0, fama: 3, nefas: -1 },
                  { letter: "C", text: "Take spices to resell", marks: 15, fama: 0, nefas: 0 },
                  { letter: "D", text: "Enslave northern importers", marks: 20, fama: -1, nefas: 3 }
                ]
              },
              {
                choices: [
                  { letter: "A", text: "Operate shops for profit", marks: 12, fama: 1, nefas: 0 },
                  { letter: "B", text: "Take icons from shops", marks: 8, fama: 2, nefas: 1 },
                  { letter: "C", text: "Start bonfire", marks: 0, fama: -3, nefas: 2 },
                  { letter: "D", text: "Search for strongboxes", marks: 18, fama: 0, nefas: 1 }
                ]
              },
              {
                choices: [
                  { letter: "A", text: "Steal decorations", marks: 12, fama: 0, nefas: 1 },
                  { letter: "B", text: "Swim in underground lake", marks: 0, fama: -1, nefas: 0 },
                  { letter: "C", text: "Charge Greeks for water", marks: 20, fama: -2, nefas: 2 },
                  { letter: "D", text: "Search for hidden passages", marks: 25, fama: 1, nefas: 0 }
                ]
              }
            ]
          },
          "P3": {
            region: "Petrion",
            position: 3,
            questions: [
              {
                choices: [
                  { letter: "A", text: "Break wine-shop door, kill owner, take wine", marks: 10, fama: -2, nefas: 2 },
                  { letter: "B", text: "Distribute food to Greeks", marks: 0, fama: 3, nefas: -1 },
                  { letter: "C", text: "Take spices to resell", marks: 15, fama: 0, nefas: 0 },
                  { letter: "D", text: "Enslave northern importers", marks: 20, fama: -1, nefas: 3 }
                ]
              },
              {
                choices: [
                  { letter: "A", text: "Operate shops for profit", marks: 12, fama: 1, nefas: 0 },
                  { letter: "B", text: "Take icons from shops", marks: 8, fama: 2, nefas: 1 },
                  { letter: "C", text: "Start bonfire", marks: 0, fama: -3, nefas: 2 },
                  { letter: "D", text: "Search for strongboxes", marks: 18, fama: 0, nefas: 1 }
                ]
              },
              {
                choices: [
                  { letter: "A", text: "Pray at Constantine's tomb", marks: 0, fama: 2, nefas: -1 },
                  { letter: "B", text: "Take Constantine's relics", marks: 15, fama: 5, nefas: 3 },
                  { letter: "C", text: "Loot Constantine's personal effects", marks: 30, fama: 0, nefas: 2 },
                  { letter: "D", text: "Sell tomb location to others", marks: 10, fama: -2, nefas: 1 }
                ]
              }
            ]
          }
        };

        const DecoderTool = () => {
            const [codesInput, setCodesInput] = useState('');
            const [results, setResults] = useState(null);
            const [errorMessages, setErrorMessages] = useState([]);

            const decodeResults = () => {
                const lines = codesInput.trim().split('\n').filter(line => line.trim());
                const decodedResults = [];
                const errors = [];

                lines.forEach((line, idx) => {
                    const code = line.trim().toUpperCase();
                    
                    // Parse code: [01][P1][ABC]
                    // Characters 0-1: Character ID
                    // Characters 2-3: Scenario code
                    // Characters 4-6: Choices
                    
                    if (code.length !== 7) {
                        errors.push(`Line ${idx + 1}: Invalid code length "${code}" (should be 7 characters)`);
                        return;
                    }

                    const charId = parseInt(code.substring(0, 2));
                    const scenarioCode = code.substring(2, 4);
                    const choices = code.substring(4, 7).split('');

                    // Validate
                    const character = CHARACTERS.find(c => c.id === charId);
                    const scenario = SCENARIOS[scenarioCode];

                    if (!character) {
                        errors.push(`Line ${idx + 1}: Invalid character ID ${charId}`);
                        return;
                    }

                    if (!scenario) {
                        errors.push(`Line ${idx + 1}: Unknown scenario code "${scenarioCode}"`);
                        return;
                    }

                    if (choices.length !== 3) {
                        errors.push(`Line ${idx + 1}: Should have exactly 3 choices`);
                        return;
                    }

                    // Calculate results
                    let marks = 0;
                    let fama = 0;
                    let nefas = 0;
                    const choiceDetails = [];

                    choices.forEach((letter, qIdx) => {
                        const question = scenario.questions[qIdx];
                        const choice = question.choices.find(c => c.letter === letter);

                        if (!choice) {
                            errors.push(`Line ${idx + 1}: Invalid choice "${letter}" for question ${qIdx + 1}`);
                            return;
                        }

                        marks += choice.marks;
                        fama += choice.fama;
                        nefas += choice.nefas;
                        choiceDetails.push({
                            question: qIdx + 1,
                            choice: letter,
                            text: choice.text,
                            marks: choice.marks,
                            fama: choice.fama,
                            nefas: choice.nefas
                        });
                    });

                    decodedResults.push({
                        code,
                        character,
                        scenario: { code: scenarioCode, ...scenario },
                        choices,
                        choiceDetails,
                        totals: { marks, fama, nefas }
                    });
                });

                setErrorMessages(errors);
                setResults(decodedResults);
            };

            const calculateClassTotals = () => {
                if (!results || results.length === 0) return null;

                const totals = results.reduce((acc, r) => {
                    acc.marks += r.totals.marks;
                    acc.fama += r.totals.fama;
                    acc.nefas += r.totals.nefas;
                    return acc;
                }, { marks: 0, fama: 0, nefas: 0 });

                const avg = {
                    marks: (totals.marks / results.length).toFixed(1),
                    fama: (totals.fama / results.length).toFixed(1),
                    nefas: (totals.nefas / results.length).toFixed(1)
                };

                return { totals, avg, count: results.length };
            };

            const exportToCSV = () => {
                if (!results || results.length === 0) return;

                const headers = ['Character ID', 'Character Name', 'Scenario', 'Choices', 'Marks', 'Fama', 'Nefas'];
                const rows = results.map(r => [
                    r.character.id,
                    r.character.name,
                    r.scenario.code,
                    r.choices.join(''),
                    r.totals.marks,
                    r.totals.fama,
                    r.totals.nefas
                ]);

                const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sack-results.csv';
                a.click();
            };

            const classStats = calculateClassTotals();

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-lg shadow-lg p-8 mb-8">
                            <h1 className="text-4xl font-bold mb-2">üéì Sack Results Decoder</h1>
                            <p className="text-xl text-blue-100">Instructor Tool - Fourth Crusade Game</p>
                        </div>

                        {/* Instructions */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 className="text-2xl font-bold mb-4 text-gray-800">Instructions</h2>
                            <ol className="space-y-2 text-gray-700">
                                <li>1. Collect result codes from students (one per line)</li>
                                <li>2. Paste all codes into the text area below</li>
                                <li>3. Click "Decode Results" to generate individual and class summaries</li>
                                <li>4. Export to CSV for gradebook integration</li>
                            </ol>
                            <div className="mt-4 p-4 bg-blue-50 rounded border-l-4 border-blue-500">
                                <p className="text-sm text-gray-700">
                                    <strong>Code Format:</strong> Each code is 7 characters: 
                                    <code className="bg-gray-200 px-2 py-1 rounded ml-2">01P1ABC</code>
                                    <br />
                                    <span className="text-xs text-gray-600">
                                        [Character ID (2 digits)][Scenario Code (2 chars)][Three Choices (3 letters A-D)]
                                    </span>
                                </p>
                            </div>
                        </div>

                        {/* Input Area */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 className="text-2xl font-bold mb-4 text-gray-800">Enter Student Codes</h2>
                            <textarea
                                className="w-full h-48 p-4 border-2 border-gray-300 rounded font-mono text-sm focus:border-blue-500 focus:outline-none"
                                placeholder="Paste student codes here (one per line)...
Example:
01P1ABC
05P2DAB
12P3BCD"
                                value={codesInput}
                                onChange={(e) => setCodesInput(e.target.value)}
                            />
                            <div className="mt-4 flex gap-4">
                                <button
                                    onClick={decodeResults}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow transition-colors"
                                >
                                    üîç Decode Results
                                </button>
                                <button
                                    onClick={() => {
                                        setCodesInput('');
                                        setResults(null);
                                        setErrorMessages([]);
                                    }}
                                    className="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg shadow transition-colors"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>

                        {/* Error Messages */}
                        {errorMessages.length > 0 && (
                            <div className="bg-red-50 border-l-4 border-red-500 rounded-lg p-6 mb-6">
                                <h3 className="text-lg font-bold text-red-800 mb-2">‚ö†Ô∏è Errors Found:</h3>
                                <ul className="space-y-1">
                                    {errorMessages.map((msg, idx) => (
                                        <li key={idx} className="text-red-700 text-sm">{msg}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {/* Class Summary */}
                        {classStats && (
                            <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg shadow-md p-6 mb-6 border-2 border-green-300">
                                <div className="flex justify-between items-start mb-4">
                                    <h2 className="text-2xl font-bold text-gray-800">üìä Class Summary</h2>
                                    <button
                                        onClick={exportToCSV}
                                        className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow"
                                    >
                                        üì• Export CSV
                                    </button>
                                </div>
                                <div className="grid grid-cols-4 gap-4 mb-4">
                                    <div className="bg-white rounded-lg p-4 shadow">
                                        <div className="text-3xl font-bold text-blue-600">{classStats.count}</div>
                                        <div className="text-sm text-gray-600">Students</div>
                                    </div>
                                    <div className="bg-white rounded-lg p-4 shadow">
                                        <div className="text-3xl font-bold text-yellow-600">{classStats.totals.marks}</div>
                                        <div className="text-sm text-gray-600">Total Marks</div>
                                        <div className="text-xs text-gray-500">Avg: {classStats.avg.marks}</div>
                                    </div>
                                    <div className="bg-white rounded-lg p-4 shadow">
                                        <div className="text-3xl font-bold text-blue-600">
                                            {classStats.totals.fama > 0 ? '+' : ''}{classStats.totals.fama}
                                        </div>
                                        <div className="text-sm text-gray-600">Total Fama</div>
                                        <div className="text-xs text-gray-500">Avg: {classStats.avg.fama}</div>
                                    </div>
                                    <div className="bg-white rounded-lg p-4 shadow">
                                        <div className="text-3xl font-bold text-red-600">
                                            {classStats.totals.nefas > 0 ? '+' : ''}{classStats.totals.nefas}
                                        </div>
                                        <div className="text-sm text-gray-600">Total Nefas</div>
                                        <div className="text-xs text-gray-500">Avg: {classStats.avg.nefas}</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Individual Results */}
                        {results && results.length > 0 && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Individual Results</h2>
                                {results.map((result, idx) => (
                                    <div key={idx} className="bg-white rounded-lg shadow-md p-6">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 className="text-xl font-bold text-gray-800">
                                                    {result.character.name}
                                                </h3>
                                                <p className="text-sm text-gray-600">
                                                    Code: <code className="bg-gray-100 px-2 py-1 rounded">{result.code}</code>
                                                    {' ‚Ä¢ '}
                                                    Scenario: {result.scenario.code} ({result.scenario.region}, Position {result.scenario.position})
                                                </p>
                                            </div>
                                            <div className="flex gap-4">
                                                <div className="text-center">
                                                    <div className="text-2xl font-bold text-yellow-600">{result.totals.marks}</div>
                                                    <div className="text-xs text-gray-600">Marks</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-2xl font-bold text-blue-600">
                                                        {result.totals.fama > 0 ? '+' : ''}{result.totals.fama}
                                                    </div>
                                                    <div className="text-xs text-gray-600">Fama</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-2xl font-bold text-red-600">
                                                        {result.totals.nefas > 0 ? '+' : ''}{result.totals.nefas}
                                                    </div>
                                                    <div className="text-xs text-gray-600">Nefas</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border-t pt-4">
                                            <h4 className="font-bold text-gray-700 mb-2">Choices Made:</h4>
                                            <div className="space-y-2">
                                                {result.choiceDetails.map((detail, qIdx) => (
                                                    <div key={qIdx} className="text-sm bg-gray-50 p-3 rounded">
                                                        <span className="font-bold text-gray-800">Q{detail.question}: Choice {detail.choice}</span>
                                                        {' - '}
                                                        <span className="text-gray-700">{detail.text}</span>
                                                        <div className="text-xs text-gray-600 mt-1">
                                                            +{detail.marks} marks, {detail.fama > 0 ? '+' : ''}{detail.fama} fama, {detail.nefas > 0 ? '+' : ''}{detail.nefas} nefas
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Footer */}
                        <div className="mt-8 text-center text-gray-600 text-sm">
                            <p>Fourth Crusade: Sack of Constantinople - Instructor Decoder Tool</p>
                            <p className="text-xs mt-1">Currently supports: Petrion scenarios (P1-P3)</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DecoderTool />, document.getElementById('root'));
    </script>
</body>
</html>
